service: ec2-instances
provider:
  name: aws
  runtime: python2.7
  timeout: ${file(./serverless.env.yml):${opt:stage}.TIME_OUT}
  iamRoleStatements:
    - Effect: Allow
      Action:
      - "logs:CreateLogGroup"
      Resource: "arn:aws:logs:*:*:*"
    - Effect: Allow
      Action:
      - "logs:CreateLogStream"
      Resource: "arn:aws:logs:*:*:*"
    - Effect: Allow
      Action:
      - "logs:PutLogEvents"
      Resource: "arn:aws:logs:*:*:*"
    - Effect: Allow
      Action:
      - "dynamodb:PutItem"
      Resource: "arn:aws:dynamodb:*:*:*"
    - Effect: Allow
      Action:
      - "dynamodb:BatchWriteItem"
      Resource: "arn:aws:dynamodb:*:*:*"
  environment:
    REGION: ${opt:region}
functions:
  EC2Descriptors:
    handler: handler.source_lists
    description: EC2 instance state for ${file(./serverless.env.yml):${opt:stage}.ENVIRONMENT} environment
    name: ec2_decriptor_${file(./serverless.env.yml):${opt:stage}.ENVIRONMENT}
    memorySize: 2048
    events:
     - schedule: cron(0 18 ? * MON-FRI *)
resources:
  Resources:
    usersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: dl-context-ec2-descriptor
        AttributeDefinitions:
          - AttributeName: EC2_ID
            AttributeType: S
        KeySchema:
          - AttributeName: EC2_ID
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        TimeToLiveSpecification:
          AttributeName: IP
          Enabled: True
